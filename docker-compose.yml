services:
  ansible-web:
    build: .
    container_name: ansible-simpleweb
    ports:
      - "3001:3001"
      # HTTPS port (enable SSL_ENABLED=true to use)
      - "3443:3443"
    volumes:
      # Mount playbooks for easy editing
      - ./playbooks:/app/playbooks
      # Mount logs for persistence
      - ./logs:/app/logs
      # Mount inventory for easy editing
      - ./inventory:/app/inventory
      # Mount web app for development
      - ./web:/app/web
      # Mount config for themes and certificates
      - ./config:/app/config
      # Mount custom Ansible modules
      - ./library:/app/library
      # Mount callback plugins for CMDB collection
      - ./callback_plugins:/app/callback_plugins
      # Mount ansible.cfg for config changes without image rebuild
      - ./ansible.cfg:/app/ansible.cfg
      # Mount SSH keys for svc-ansible (read-only system keys)
      - ./.ssh:/app/.ssh:ro
      # Mount user SSH keys if they exist
      - ~/.ssh:/root/.ssh:ro
      # Mount directory for uploaded SSH keys (writable)
      - ./ssh-keys:/app/ssh-keys
      # Mount gunicorn config for production mode
      - ./gunicorn_config.py:/app/gunicorn_config.py
    environment:
      - FLASK_ENV=development
      - FLASK_APP=web/app.py
      # Storage backend: 'flatfile' or 'mongodb'
      - STORAGE_BACKEND=mongodb
      # MongoDB connection (used when STORAGE_BACKEND=mongodb)
      - MONGODB_HOST=mongodb
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=ansible_simpleweb
      # Cluster mode configuration
      - CLUSTER_MODE=primary
      - REGISTRATION_TOKEN=cluster-secret-token-change-in-prod
      - CHECKIN_INTERVAL=60
      - LOCAL_WORKER_TAGS=local,primary
      # SSL Configuration (set SSL_ENABLED=true to enable HTTPS)
      - SSL_ENABLED=${SSL_ENABLED:-false}
      - SSL_CERT_PATH=/app/config/certs/server.crt
      - SSL_KEY_PATH=/app/config/certs/server.key
      - SSL_HOSTNAME=${SSL_HOSTNAME:-localhost}
      # Authentication (set AUTH_ENABLED=true to require login)
      - AUTH_ENABLED=${AUTH_ENABLED:-false}
      - INITIAL_ADMIN_USER=${INITIAL_ADMIN_USER:-admin}
      - INITIAL_ADMIN_PASSWORD=${INITIAL_ADMIN_PASSWORD:-}
    depends_on:
      - mongodb
    restart: unless-stopped

  mongodb:
    image: mongo:7
    container_name: ansible-simpleweb-mongodb
    ports:
      - "27017:27017"
    volumes:
      # Persistent data storage
      - mongodb_data:/data/db
    environment:
      # No auth for local development - add MONGO_INITDB_ROOT_USERNAME/PASSWORD for production
      - MONGO_INITDB_DATABASE=ansible_simpleweb
    restart: unless-stopped

  # Worker 1 - General purpose
  # Workers need network access to target hosts. Options:
  # 1. Use Docker's default bridge network (targets must be reachable from Docker network)
  # 2. Use host network mode (uncomment network_mode below, comment out depends_on)
  # 3. Add extra_hosts for DNS resolution
  worker-1:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: ansible-worker-1
    # network_mode: host  # Uncomment for direct host network access to targets
    volumes:
      # SSH keys for target authentication (must match primary)
      - ./.ssh:/app/.ssh:ro
      - ./ssh-keys:/app/ssh-keys:ro
      - ~/.ssh:/root/.ssh:ro
      # Mount ansible.cfg for config changes without image rebuild
      - ./ansible.cfg:/app/ansible.cfg
      # Mount worker code for development
      - ./worker:/app/worker
      # Mount web code for CMDB collector dependencies
      - ./web:/app/web:ro
    environment:
      - WORKER_NAME=worker-1
      - SERVER_URL=http://ansible-web:3001
      - REGISTRATION_TOKEN=cluster-secret-token-change-in-prod
      - WORKER_TAGS=general,zone-a
      - CHECKIN_INTERVAL=60
      - SYNC_INTERVAL=120
      - MAX_CONCURRENT_JOBS=2
      # For MikroTik password auth (inventory/group_vars/routers.yml): set in .env
      - ROUTER_PASSWORD=${ROUTER_PASSWORD:-}
    # For host network mode, change SERVER_URL to http://localhost:3001
    depends_on:
      - ansible-web
    # extra_hosts:  # Add DNS entries for targets if needed
    #   - "target1.example.com:192.168.1.100"
    #   - "target2.example.com:192.168.1.101"
    restart: unless-stopped

  # Worker 2 - High memory workloads
  worker-2:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: ansible-worker-2
    # network_mode: host  # Uncomment for direct host network access to targets
    environment:
      - WORKER_NAME=worker-2
      - SERVER_URL=http://ansible-web:3001
      - REGISTRATION_TOKEN=cluster-secret-token-change-in-prod
      - WORKER_TAGS=general,zone-b,high-memory
      - CHECKIN_INTERVAL=60
      - SYNC_INTERVAL=120
      - MAX_CONCURRENT_JOBS=2
      - ROUTER_PASSWORD=${ROUTER_PASSWORD:-}
    volumes:
      - ./.ssh:/app/.ssh:ro
      - ./ssh-keys:/app/ssh-keys:ro
      - ~/.ssh:/root/.ssh:ro
      - ./ansible.cfg:/app/ansible.cfg
      - ./worker:/app/worker
      - ./web:/app/web:ro
    depends_on:
      - ansible-web
    restart: unless-stopped

  # Worker 3 - Network operations
  worker-3:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: ansible-worker-3
    # network_mode: host  # Uncomment for direct host network access to targets
    environment:
      - WORKER_NAME=worker-3
      - SERVER_URL=http://ansible-web:3001
      - REGISTRATION_TOKEN=cluster-secret-token-change-in-prod
      - WORKER_TAGS=general,zone-c,network
      - CHECKIN_INTERVAL=60
      - SYNC_INTERVAL=120
      - MAX_CONCURRENT_JOBS=2
      - ROUTER_PASSWORD=${ROUTER_PASSWORD:-}
    volumes:
      - ./.ssh:/app/.ssh:ro
      - ./ssh-keys:/app/ssh-keys:ro
      - ~/.ssh:/root/.ssh:ro
      - ./ansible.cfg:/app/ansible.cfg
      - ./worker:/app/worker
      - ./web:/app/web:ro
    depends_on:
      - ansible-web
    restart: unless-stopped

  # Ollama LLM (required for agent log review; part of this projectâ€”status and logs are our responsibility)
  ollama:
    image: ollama/ollama
    container_name: ansible-ollama
    volumes:
      - ollama_data:/root/.ollama
    # Do NOT publish 11434 to host - prevents Cursor/IDE/tools from connecting and potentially
    # starting host Ollama. Agent reaches this via Docker network (ollama:11434).
    # ports:
    #   - "11434:11434"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    # Pull model on first run (lightweight): docker compose exec ollama ollama run qwen2.5-coder:1.5b
    # Logs: docker compose logs ollama

  # Agent Service
  agent-service:
    build:
      context: .
      dockerfile: Dockerfile.agent
    container_name: ansible-agent
    volumes:
      # Access to logs for review
      - ./logs:/app/logs:ro
      # Access to playbooks for analysis
      - ./playbooks:/app/playbooks:ro
      # Access to documentation for RAG
      - ./docs:/app/docs:ro
      # Mount agent code
      - ./agent:/app/agent
      # Vector database persistence
      - agent_data:/app/data
    environment:
      - SERVER_URL=http://ansible-web:3001
      - LLM_API_URL=http://ollama:11434/v1
      - LLM_MODEL=qwen2.5-coder:3b
      - POLL_INTERVAL=300
    ports:
      - "5001:5000"
    depends_on:
      ansible-web:
        condition: service_started
      ollama:
        condition: service_healthy
    restart: unless-stopped

volumes:
  mongodb_data:
    driver: local
  agent_data:
    driver: local
  ollama_data:
    driver: local
