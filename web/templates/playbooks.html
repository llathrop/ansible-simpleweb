{% extends "base.html" %}
{% block title %}Playbooks | Ansible Web Interface{% endblock %}

{% block content %}
<div class="container">
    <h1>Individual Playbooks</h1>
    <p class="subtitle">Run single playbooks against specific targets</p>

    <div class="refresh-note" id="statusNote">
        Real-time updates via WebSocket. Click "Watch Live" to see playbook output as it runs.
    </div>

    {% if playbooks %}
    <div class="playbook-grid">
        {% for playbook in playbooks %}
        <div class="playbook-card" data-playbook="{{ playbook.name }}">
            <div class="playbook-header">
                <div class="playbook-name">{{ playbook.display_name }}</div>
                <span class="status-badge status-{{ playbook.status }}" data-status>{{ playbook.status }}</span>
            </div>

            <div class="playbook-info">
                <strong>Last Run:</strong> {{ playbook.last_run }}<br>
                {% if playbook.latest_log %}
                <strong>Latest Log:</strong> {{ playbook.latest_log }}
                {% endif %}
            </div>

            <div class="playbook-actions">
                <form action="/run/{{ playbook.name }}" method="get" class="run-form">
                    <div class="target-label">Target Host/Group:</div>
                    <select name="target" class="target-select">
                        {% for target in targets %}
                        <option value="{{ target.value }}">{{ target.label }}</option>
                        {% endfor %}
                    </select>

                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            Run Playbook
                        </button>

                        <a href="/schedules/new?playbook={{ playbook.name }}" class="btn btn-secondary" title="Schedule automated runs">Schedule</a>

                        {% if playbook.latest_log %}
                        <a href="/logs/{{ playbook.latest_log }}" class="btn btn-secondary">View Log</a>
                        {% else %}
                        <button class="btn btn-secondary" disabled>No Logs</button>
                        {% endif %}
                    </div>
                </form>
            </div>

            <div class="active-runs" data-active-runs style="{% if not playbook.active_runs %}display: none;{% endif %}">
                <div class="active-runs-title">Active Runs:</div>
                <div class="active-runs-list">
                    {% for run in playbook.active_runs %}
                    <div class="active-run-item {{ run.status }}" data-run-id="{{ run.run_id }}">
                        <span class="active-run-target">{{ run.target }}</span>
                        <span class="active-run-worker" style="color: var(--text-muted); font-size: 12px;">on {{ run.worker_name or 'local-executor' }}</span>
                        <a href="/live/{{ run.run_id }}" class="btn btn-watch">Watch Live</a>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p style="color: var(--text-muted); text-align: center; padding: 40px;">No playbooks found in /app/playbooks</p>
    {% endif %}
</div>

{% endblock %}

{% block footer_scripts %}
<script>
(function() {
    const socket = window.__socket || io();

    socket.on('status_update', function(data) {
        updatePlaybookStatus(data.playbook, data.status, data.run_id, data.target, data.worker_name);
    });

    function updatePlaybookStatus(playbookName, status, runId, target, workerName) {
        const card = document.querySelector('[data-playbook="' + playbookName + '"]');
        if (!card) return;

        const badge = card.querySelector('[data-status]');
        const activeRunsSection = card.querySelector('[data-active-runs]');
        const activeRunsList = card.querySelector('.active-runs-list');

        if (badge) {
            badge.textContent = status;
            badge.className = 'status-badge status-' + status;
        }

        if ((status === 'running' || status === 'starting') && runId) {
            activeRunsSection.style.display = 'block';

            let runItem = activeRunsList.querySelector('[data-run-id="' + runId + '"]');
            if (!runItem) {
                runItem = document.createElement('div');
                runItem.className = 'active-run-item running';
                runItem.dataset.runId = runId;
                runItem.innerHTML = '<span class="active-run-target">' + (target || 'unknown') + '</span>' +
                    '<span class="active-run-worker" style="color: var(--text-muted); font-size: 12px;">on ' + (workerName || 'local-executor') + '</span>' +
                    '<a href="/live/' + runId + '" class="btn btn-watch">Watch Live</a>';
                activeRunsList.appendChild(runItem);
            }
        } else if ((status === 'completed' || status === 'failed') && runId) {
            const runItem = activeRunsList.querySelector('[data-run-id="' + runId + '"]');
            if (runItem) {
                runItem.className = 'active-run-item ' + status;
                const btn = runItem.querySelector('.btn-watch');
                if (btn) {
                    btn.textContent = 'View Log';
                    btn.classList.remove('btn-watch');
                    btn.classList.add('btn-secondary');
                }
                setTimeout(function() {
                    runItem.remove();
                    if (activeRunsList.children.length === 0) {
                        activeRunsSection.style.display = 'none';
                    }
                    fetch('/api/status')
                        .then(function(r) { return r.json(); })
                        .then(function(statusData) {
                            const playbookStatus = statusData[playbookName];
                            if (playbookStatus && playbookStatus.status) {
                                badge.textContent = playbookStatus.status;
                                badge.className = 'status-badge status-' + playbookStatus.status;
                            }
                        });
                }, 5000);
            }
        }
    }

    setInterval(function() {
        fetch('/api/runs')
            .then(function(response) { return response.json(); })
            .then(function(runs) {
                Object.keys(runs).forEach(function(runId) {
                    const run = runs[runId];
                    updatePlaybookStatus(run.playbook, run.status, runId, run.target);
                });
            });
    }, 10000);
})();
</script>
{% endblock %}
