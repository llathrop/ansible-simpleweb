{% extends "base.html" %}
{% block title %}{% if edit_mode %}Edit{% else %}New{% endif %} Schedule - Ansible Web Interface{% endblock %}

{% block head_extras %}
<style>
        /* Schedule type toggle */
        .schedule-type-toggle {
            display: flex;
            gap: 0;
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            overflow: hidden;
            width: fit-content;
        }

        .toggle-btn {
            padding: 10px 20px;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .toggle-btn:hover {
            background: var(--table-row-hover);
        }

        .toggle-btn.active {
            background: var(--btn-primary-bg);
            color: var(--btn-primary-text);
        }

        /* Batch order item */
        .batch-order-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-primary);
            background: var(--bg-secondary);
        }

        .batch-order-item:last-child {
            border-bottom: none;
        }

        .batch-order-item .order-number {
            width: 24px;
            height: 24px;
            background: var(--btn-primary-bg);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            margin-right: 10px;
        }

        .batch-order-item .playbook-name {
            flex: 1;
            font-size: 14px;
        }

        .batch-order-item .order-buttons {
            display: flex;
            gap: 4px;
        }

        .batch-order-item .order-btn {
            width: 28px;
            height: 28px;
            border: 1px solid var(--border-primary);
            background: var(--bg-tertiary);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .batch-order-item .order-btn:hover {
            background: var(--table-row-hover);
        }

        @media (max-width: 768px) {
            .batch-grid {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="container">
    <h1>{% if edit_mode %}Edit Schedule{% else %}New Schedule{% endif %}</h1>
    <p><a href="/schedules">&larr; Back to Schedules</a></p>

    <form action="{% if edit_mode %}/schedules/{{ schedule.id }}/update{% else %}/schedules/create{% endif %}"
              method="POST" class="schedule-form" id="scheduleForm">

            <!-- Hidden fields for batch mode -->
            <input type="hidden" id="is_batch" name="is_batch" value="{{ 'true' if (schedule and schedule.is_batch) or batch_mode else 'false' }}">
            <input type="hidden" id="playbooks_hidden" name="playbooks" value="{{ batch_playbooks|default('', true) }}">
            <input type="hidden" id="targets_hidden" name="targets" value="{{ batch_targets|default('', true) }}">

            <!-- Schedule Type Toggle (only show on create) -->
            {% if not edit_mode %}
            <div class="form-group">
                <label>Schedule Type</label>
                <div class="schedule-type-toggle">
                    <button type="button" id="singleModeBtn" class="toggle-btn {% if not batch_mode %}active{% endif %}" onclick="setScheduleMode('single')">
                        Single Playbook
                    </button>
                    <button type="button" id="batchModeBtn" class="toggle-btn {% if batch_mode %}active{% endif %}" onclick="setScheduleMode('batch')">
                        Batch Job
                    </button>
                </div>
            </div>
            {% endif %}

            <div class="form-group">
                <label for="name">Schedule Name *</label>
                <input type="text" id="name" name="name" required
                       placeholder="e.g., Daily Backup, Weekly Health Check"
                       value="{{ schedule.name if schedule else (batch_name|default('', true)) }}">
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <input type="text" id="description" name="description"
                       placeholder="Optional description"
                       value="{{ schedule.description if schedule else '' }}">
            </div>

            <!-- Single Playbook Mode -->
            <div id="singleModeFields" style="{% if batch_mode %}display: none;{% endif %}">
                <div class="form-group">
                    <label for="playbook">Playbook *</label>
                    <select id="playbook" name="playbook" {% if edit_mode %}disabled{% endif %}>
                        {% for pb in playbooks %}
                        <option value="{{ pb }}"
                                {% if (schedule and schedule.playbook == pb) or (selected_playbook == pb) %}selected{% endif %}>
                            {{ pb.replace('-', ' ').title() }}
                        </option>
                        {% endfor %}
                    </select>
                    {% if edit_mode %}
                    <input type="hidden" name="playbook" value="{{ schedule.playbook }}">
                    <small class="text-muted">Playbook cannot be changed after creation</small>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="target">Target Host/Group *</label>
                    <select id="target" name="target">
                        {% for t in targets %}
                        <option value="{{ t.value }}"
                                {% if schedule and schedule.target == t.value %}selected{% endif %}>
                            {{ t.label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Batch Mode Fields -->
            <div id="batchModeFields" style="{% if not batch_mode %}display: none;{% endif %}">
                <div class="batch-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label>Select Playbooks</label>
                        <div class="multi-select-list" id="batchPlaybookList" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-primary); border-radius: 4px;">
                            {% for pb in playbooks %}
                            <div class="multi-select-item" onclick="toggleBatchPlaybook(this, '{{ pb }}')">
                                <input type="checkbox" value="{{ pb }}" {% if pb in (batch_playbooks_list|default([], true)) %}checked{% endif %}>
                                <label>{{ pb.replace('-', ' ').title() }}</label>
                            </div>
                            {% endfor %}
                        </div>
                        <small id="playbookCount" style="color: var(--text-muted);">0 playbook(s) selected</small>
                    </div>

                    <div class="form-group">
                        <label>Select Targets</label>
                        <div class="multi-select-list" id="batchTargetList" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-primary); border-radius: 4px;">
                            {% for t in targets %}
                            <div class="multi-select-item" onclick="toggleBatchTarget(this, '{{ t.value }}')">
                                <input type="checkbox" value="{{ t.value }}" {% if t.value in (batch_targets_list|default([], true)) %}checked{% endif %}>
                                <label>{{ t.label }}</label>
                            </div>
                            {% endfor %}
                        </div>
                        <small id="targetCount" style="color: var(--text-muted);">0 target(s) selected</small>
                    </div>
                </div>

                <div class="form-group">
                    <label>Execution Order</label>
                    <div id="batchOrderList" style="border: 1px solid var(--border-primary); border-radius: 4px; min-height: 60px; background: var(--bg-primary);">
                        <div id="batchOrderEmpty" style="padding: 20px; text-align: center; color: var(--text-muted);">
                            Select playbooks above to set execution order
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="recurrence_type">Recurrence *</label>
                <select id="recurrence_type" name="recurrence_type" required onchange="updateRecurrenceOptions()">
                    <option value="once" {% if schedule and schedule.recurrence.type == 'once' %}selected{% endif %}>
                        Once (single run)
                    </option>
                    <option value="hourly" {% if schedule and schedule.recurrence.type == 'hourly' %}selected{% endif %}>
                        Hourly
                    </option>
                    <option value="daily" {% if schedule and schedule.recurrence.type == 'daily' %}selected{% endif %}>
                        Daily
                    </option>
                    <option value="weekly" {% if schedule and schedule.recurrence.type == 'weekly' %}selected{% endif %}>
                        Weekly
                    </option>
                    <option value="monthly" {% if schedule and schedule.recurrence.type == 'monthly' %}selected{% endif %}>
                        Monthly
                    </option>
                    <option value="custom" {% if schedule and schedule.recurrence.type == 'custom' %}selected{% endif %}>
                        Custom interval
                    </option>
                </select>
            </div>

            <!-- Recurrence-specific options -->
            <div id="recurrence-options">
                <!-- Once: datetime picker -->
                <div id="once-options" class="recurrence-option form-group" style="display: none;">
                    <label for="once_datetime">Run At</label>
                    <input type="datetime-local" id="once_datetime" name="once_datetime"
                           value="{{ schedule.recurrence.datetime[:16] if schedule and schedule.recurrence.type == 'once' and schedule.recurrence.datetime else '' }}">
                </div>

                <!-- Hourly: minute of hour -->
                <div id="hourly-options" class="recurrence-option form-group" style="display: none;">
                    <label for="hourly_minute">Minute of Hour</label>
                    <select id="hourly_minute" name="hourly_minute">
                        {% for m in range(0, 60, 5) %}
                        <option value="{{ m }}"
                                {% if schedule and schedule.recurrence.type == 'hourly' and schedule.recurrence.minute == m %}selected{% endif %}>
                            :{{ '%02d'|format(m) }}
                        </option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">Run at this minute every hour</small>
                </div>

                <!-- Daily: time picker -->
                <div id="daily-options" class="recurrence-option form-group" style="display: none;">
                    <label for="daily_time">Time</label>
                    <input type="time" id="daily_time" name="daily_time"
                           value="{{ schedule.recurrence.time if schedule and schedule.recurrence.type == 'daily' else '09:00' }}">
                </div>

                <!-- Weekly: day checkboxes + time -->
                <div id="weekly-options" class="recurrence-option" style="display: none;">
                    <div class="form-group">
                        <label>Days of Week</label>
                        <div class="checkbox-group">
                            {% set day_names = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] %}
                            {% for i in range(7) %}
                            <label class="checkbox-label">
                                <input type="checkbox" name="weekly_days" value="{{ i }}"
                                       {% if schedule and schedule.recurrence.type == 'weekly' and i in schedule.recurrence.days %}checked{% endif %}>
                                {{ day_names[i][:3] }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="weekly_time">Time</label>
                        <input type="time" id="weekly_time" name="weekly_time"
                               value="{{ schedule.recurrence.time if schedule and schedule.recurrence.type == 'weekly' else '09:00' }}">
                    </div>
                </div>

                <!-- Monthly: day of month + time -->
                <div id="monthly-options" class="recurrence-option" style="display: none;">
                    <div class="form-group">
                        <label for="monthly_day">Day of Month</label>
                        <select id="monthly_day" name="monthly_day">
                            {% for d in range(1, 29) %}
                            <option value="{{ d }}"
                                    {% if schedule and schedule.recurrence.type == 'monthly' and schedule.recurrence.day == d %}selected{% endif %}>
                                {{ d }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Days 29-31 may be skipped in shorter months</small>
                    </div>
                    <div class="form-group">
                        <label for="monthly_time">Time</label>
                        <input type="time" id="monthly_time" name="monthly_time"
                               value="{{ schedule.recurrence.time if schedule and schedule.recurrence.type == 'monthly' else '09:00' }}">
                    </div>
                </div>

                <!-- Custom: interval in minutes -->
                <div id="custom-options" class="recurrence-option form-group" style="display: none;">
                    <label for="custom_minutes">Interval (minutes)</label>
                    <input type="number" id="custom_minutes" name="custom_minutes" min="1" max="10080"
                           value="{{ schedule.recurrence.interval_minutes if schedule and schedule.recurrence.type == 'custom' else '60' }}">
                    <small class="text-muted">Run every X minutes (1-10080, max 1 week)</small>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    {% if edit_mode %}Update Schedule{% else %}Create Schedule{% endif %}
                </button>
                <a href="/schedules" class="btn btn-secondary">Cancel</a>
            </div>
    </form>
</div>
{% endblock %}

{% block footer_scripts %}
<script>
        // Batch mode state
        const batchState = {
            playbooks: [],
            targets: []
        };

        // Initialize from URL params (when coming from main page "Schedule Batch" button)
        function initFromUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('batch') === 'true') {
                setScheduleMode('batch');

                const playbooks = urlParams.get('playbooks');
                const targets = urlParams.get('targets');
                const name = urlParams.get('name');

                if (playbooks) {
                    playbooks.split(',').forEach(pb => {
                        if (pb.trim()) {
                            batchState.playbooks.push(pb.trim());
                            // Check the checkbox
                            const item = document.querySelector(`#batchPlaybookList .multi-select-item input[value="${pb.trim()}"]`);
                            if (item) {
                                item.checked = true;
                                item.closest('.multi-select-item').classList.add('selected');
                            }
                        }
                    });
                }

                if (targets) {
                    targets.split(',').forEach(t => {
                        if (t.trim()) {
                            batchState.targets.push(t.trim());
                            // Check the checkbox
                            const item = document.querySelector(`#batchTargetList .multi-select-item input[value="${t.trim()}"]`);
                            if (item) {
                                item.checked = true;
                                item.closest('.multi-select-item').classList.add('selected');
                            }
                        }
                    });
                }

                if (name) {
                    document.getElementById('name').value = name;
                }

                updateBatchUI();
            }
        }

        // Set schedule mode
        function setScheduleMode(mode) {
            const isBatch = mode === 'batch';

            document.getElementById('is_batch').value = isBatch ? 'true' : 'false';
            document.getElementById('singleModeFields').style.display = isBatch ? 'none' : 'block';
            document.getElementById('batchModeFields').style.display = isBatch ? 'block' : 'none';

            document.getElementById('singleModeBtn').classList.toggle('active', !isBatch);
            document.getElementById('batchModeBtn').classList.toggle('active', isBatch);

            // Update required attributes
            document.getElementById('playbook').required = !isBatch;
            document.getElementById('target').required = !isBatch;
        }

        // Toggle batch playbook selection
        function toggleBatchPlaybook(element, playbook) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            element.classList.toggle('selected', checkbox.checked);

            if (checkbox.checked) {
                if (!batchState.playbooks.includes(playbook)) {
                    batchState.playbooks.push(playbook);
                }
            } else {
                batchState.playbooks = batchState.playbooks.filter(p => p !== playbook);
            }

            updateBatchUI();
        }

        // Toggle batch target selection
        function toggleBatchTarget(element, target) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            element.classList.toggle('selected', checkbox.checked);

            if (checkbox.checked) {
                if (!batchState.targets.includes(target)) {
                    batchState.targets.push(target);
                }
            } else {
                batchState.targets = batchState.targets.filter(t => t !== target);
            }

            updateBatchUI();
        }

        // Move playbook in order
        function moveBatchPlaybook(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= batchState.playbooks.length) return;

            const temp = batchState.playbooks[index];
            batchState.playbooks[index] = batchState.playbooks[newIndex];
            batchState.playbooks[newIndex] = temp;
            updateBatchUI();
        }

        // Update batch UI
        function updateBatchUI() {
            // Update counts
            document.getElementById('playbookCount').textContent = batchState.playbooks.length + ' playbook(s) selected';
            document.getElementById('targetCount').textContent = batchState.targets.length + ' target(s) selected';

            // Update hidden fields
            document.getElementById('playbooks_hidden').value = batchState.playbooks.join(',');
            document.getElementById('targets_hidden').value = batchState.targets.join(',');

            // Update order list
            const orderList = document.getElementById('batchOrderList');
            if (batchState.playbooks.length === 0) {
                orderList.innerHTML = '<div id="batchOrderEmpty" style="padding: 20px; text-align: center; color: var(--text-muted);">Select playbooks above to set execution order</div>';
            } else {
                orderList.innerHTML = batchState.playbooks.map((pb, index) => `
                    <div class="batch-order-item">
                        <span class="order-number">${index + 1}</span>
                        <span class="playbook-name">${pb.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                        <div class="order-buttons">
                            <button type="button" class="order-btn" onclick="moveBatchPlaybook(${index}, -1)" ${index === 0 ? 'disabled' : ''}>&#9650;</button>
                            <button type="button" class="order-btn" onclick="moveBatchPlaybook(${index}, 1)" ${index === batchState.playbooks.length - 1 ? 'disabled' : ''}>&#9660;</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function updateRecurrenceOptions() {
            // Hide all option sections
            document.querySelectorAll('.recurrence-option').forEach(el => {
                el.style.display = 'none';
            });

            // Show the selected option
            const recurrenceType = document.getElementById('recurrence_type').value;
            const optionsDiv = document.getElementById(recurrenceType + '-options');
            if (optionsDiv) {
                optionsDiv.style.display = 'block';
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateRecurrenceOptions();
            initFromUrlParams();
        });
</script>
{% endblock %}
