{% extends "base.html" %}
{% block title %}Live Log - {{ playbook }} | Ansible Web Interface{% endblock %}
{% block main_class %}live-log-page{% endblock %}

{% block content %}
<div class="header">
    <div class="header-left">
        <h1>{{ playbook.replace('-', ' ').title() }}</h1>
        <div class="header-info">
            <span>Target: <strong>{{ target }}</strong></span>
            <span>Worker: <strong>{{ worker_name or 'local-executor' }}</strong></span>
            <span>Log: <strong>{{ log_file }}</strong></span>
        </div>
        <span id="statusBadge" class="status-badge status-{{ status }}">{{ status }}</span>
    </div>
    <div class="header-right">
        <div class="controls">
            <button id="scrollToggle" class="btn btn-toggle">Auto-scroll ON</button>
            <button id="clearBtn" class="btn btn-secondary">Clear</button>
        </div>
        <a href="/" class="btn btn-primary">Back to Dashboard</a>
    </div>
</div>

<div class="log-container" id="logContainer">
    <div class="log-content" id="logContent"></div>
</div>

<div class="footer-bar">
    <span>Run ID: {{ run_id }}</span>
    <span id="lineCount">0 lines</span>
</div>
{% endblock %}

{% block footer_scripts %}
<script>
    const runId = "{{ run_id }}";
    const logContent = document.getElementById('logContent');
    const logContainer = document.getElementById('logContainer');
    const statusBadge = document.getElementById('statusBadge');
    const connectionDot = document.getElementById('connectionDot');
    const connectionText = document.getElementById('connectionText');
    const scrollToggle = document.getElementById('scrollToggle');
    const clearBtn = document.getElementById('clearBtn');
    const lineCountEl = document.getElementById('lineCount');

    let autoScroll = true;
    let lineCount = 0;

    const socket = window.__socket || io();

    function onConnect() {
        connectionDot.classList.add('connected');
        connectionDot.classList.remove('disconnected');
        connectionText.textContent = 'Connected';
        socket.emit('join_run', { run_id: runId });
    }

    socket.on('connect', onConnect);
    if (socket.connected) {
        onConnect();
    }

    socket.on('disconnect', function() {
        connectionDot.classList.remove('connected');
        connectionDot.classList.add('disconnected');
        connectionText.textContent = 'Disconnected';
    });

    socket.on('log_catchup', function(data) {
        if (data.run_id === runId && data.content) {
            logContent.innerHTML = '';
            lineCount = 0;
            appendLogContent(data.content);
            updateStatus(data.status);
        }
    });

    socket.on('log_line', function(data) {
        if (data.run_id === runId) {
            appendLogLine(data.line);
        }
    });

    socket.on('playbook_finished', function(data) {
        if (data.run_id === runId) {
            updateStatus(data.status);
        }
    });

    socket.on('playbook_error', function(data) {
        if (data.run_id === runId) {
            appendLogLine('\n=== ERROR: ' + data.error + ' ===\n');
            updateStatus('failed');
        }
    });

    function appendLogContent(content) {
        const lines = content.split('\n');
        lines.forEach(line => {
            if (line) {
                appendLogLine(line + '\n');
            }
        });
    }

    function appendLogLine(line) {
        const lineEl = document.createElement('div');
        lineEl.className = 'log-line ' + getLineClass(line);
        lineEl.textContent = line;
        logContent.appendChild(lineEl);
        lineCount++;
        lineCountEl.textContent = lineCount + ' lines';

        if (autoScroll) {
            logContainer.scrollTop = logContainer.scrollHeight;
        }
    }

    function getLineClass(line) {
        const lowerLine = line.toLowerCase();
        if (lowerLine.includes('ok:')) return 'ok';
        if (lowerLine.includes('changed:')) return 'changed';
        if (lowerLine.includes('failed:') || lowerLine.includes('fatal:')) return 'failed';
        if (lowerLine.includes('skipping:')) return 'skipping';
        if (lowerLine.startsWith('task [') || lowerLine.startsWith('TASK [')) return 'task';
        if (lowerLine.startsWith('play [') || lowerLine.startsWith('PLAY [')) return 'play';
        if (lowerLine.includes('play recap') || lowerLine.includes('PLAY RECAP')) return 'recap';
        return '';
    }

    function updateStatus(status) {
        statusBadge.textContent = status;
        statusBadge.className = 'status-badge status-' + status;
    }

    scrollToggle.addEventListener('click', function() {
        autoScroll = !autoScroll;
        scrollToggle.textContent = autoScroll ? 'Auto-scroll ON' : 'Auto-scroll OFF';
        scrollToggle.classList.toggle('paused', !autoScroll);

        if (autoScroll) {
            logContainer.scrollTop = logContainer.scrollHeight;
        }
    });

    clearBtn.addEventListener('click', function() {
        logContent.innerHTML = '';
        lineCount = 0;
        lineCountEl.textContent = '0 lines';
    });

    logContainer.addEventListener('scroll', function() {
        const isAtBottom = logContainer.scrollHeight - logContainer.scrollTop <= logContainer.clientHeight + 50;
        if (!isAtBottom && autoScroll) {
            autoScroll = false;
            scrollToggle.textContent = 'Auto-scroll OFF';
            scrollToggle.classList.add('paused');
        }
    });
</script>
{% endblock %}
