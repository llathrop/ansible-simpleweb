<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management - Ansible Web Interface</title>
    <link rel="stylesheet" href="/static/css/base.css">
    <script>
        // Immediately apply cached theme to prevent flash of unstyled content
        (function() {
            try {
                var cached = localStorage.getItem('ansible-web-theme-vars');
                if (cached) {
                    var vars = JSON.parse(cached);
                    var root = document.documentElement;
                    for (var key in vars) {
                        if (vars[key]) root.style.setProperty(key, vars[key]);
                    }
                }
            } catch (e) {}
        })();
    </script>
    <script src="/static/js/theme.js"></script>
    <style>
        body { padding: 20px; }
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .inventory-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 15px;
        }
        .inventory-card:hover {
            box-shadow: var(--shadow-card-hover);
        }
        .inventory-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        .inventory-hostname {
            font-weight: bold;
            font-size: 1.1em;
            color: var(--text-primary);
            word-break: break-all;
        }
        .inventory-group {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        .inventory-details {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }
        .inventory-details strong {
            color: var(--text-primary);
        }
        .inventory-variables {
            background: var(--bg-tertiary);
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85em;
            margin-bottom: 10px;
            max-height: 100px;
            overflow-y: auto;
        }
        .inventory-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .modal-header h2 { margin: 0; }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--text-muted);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        .form-group textarea {
            font-family: monospace;
            min-height: 80px;
        }
        .stats-bar {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--text-primary);
        }
        .stat-label {
            font-size: 0.85em;
            color: var(--text-muted);
        }
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .search-bar input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <div class="container container-wide">
        <h1>Inventory Management</h1>
        <p class="subtitle">Manage hosts and servers in the database</p>

        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/schedules">Schedules</a>
            <a href="/storage">Storage Info</a>
            <a href="/logs">All Logs</a>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="totalItems">{{ inventory|length }}</div>
                <div class="stat-label">Total Items</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalGroups">{{ groups|length }}</div>
                <div class="stat-label">Groups</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ backend_type }}</div>
                <div class="stat-label">Storage Backend</div>
            </div>
        </div>

        <div class="action-bar" style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="showAddModal()">+ Add Host</button>
            <input type="text" id="searchInput" placeholder="Search hostname, group, or description..."
                   style="flex: 1; padding: 10px; border: 1px solid var(--border-primary); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary);"
                   onkeyup="filterInventory()">
        </div>

        {% if inventory %}
        <div class="inventory-grid" id="inventoryGrid">
            {% for item in inventory %}
            <div class="inventory-card" data-item-id="{{ item.id }}"
                 data-hostname="{{ item.hostname|lower }}"
                 data-group="{{ item.group|lower }}"
                 data-description="{{ item.description|lower }}">
                <div class="inventory-header">
                    <div class="inventory-hostname">{{ item.hostname }}</div>
                    <span class="inventory-group">{{ item.group }}</span>
                </div>
                <div class="inventory-details">
                    {% if item.display_name and item.display_name != item.hostname %}
                    <strong>Display Name:</strong> {{ item.display_name }}<br>
                    {% endif %}
                    {% if item.description %}
                    <strong>Description:</strong> {{ item.description }}<br>
                    {% endif %}
                    <strong>Created:</strong> {{ item.created[:19] if item.created else 'N/A' }}
                </div>
                {% if item.variables %}
                <div class="inventory-variables">
                    {% for key, value in item.variables.items() %}
                    {{ key }}: {{ value }}<br>
                    {% endfor %}
                </div>
                {% endif %}
                <div class="inventory-actions">
                    <button class="btn btn-secondary btn-small" onclick="showEditModal('{{ item.id }}')">Edit</button>
                    <button class="btn btn-danger btn-small" onclick="deleteItem('{{ item.id }}', '{{ item.hostname }}')">Delete</button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <p>No inventory items found.</p>
            <p>Click "Add Host" to add your first managed host.</p>
        </div>
        {% endif %}

        <div class="footer" style="margin-top: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <p>Ansible Simple Web Interface | Localhost Only</p>
                <div class="theme-selector">
                    <label for="themeSelect">Theme:</label>
                    <select id="themeSelect" class="theme-select"></select>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal" id="itemModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Host</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="itemForm" onsubmit="saveItem(event)">
                <input type="hidden" id="itemId">
                <div class="form-group">
                    <label for="hostname">Hostname / IP *</label>
                    <input type="text" id="hostname" required placeholder="server.example.com or 192.168.1.100">
                </div>
                <div class="form-group">
                    <label for="displayName">Display Name</label>
                    <input type="text" id="displayName" placeholder="Friendly name (optional)">
                </div>
                <div class="form-group">
                    <label for="group">Group</label>
                    <input type="text" id="group" placeholder="webservers, databases, etc." list="groupList">
                    <datalist id="groupList">
                        {% for g in groups %}
                        <option value="{{ g }}">
                        {% endfor %}
                    </datalist>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <input type="text" id="description" placeholder="Optional description">
                </div>
                <div class="form-group">
                    <label for="variables">Variables (JSON)</label>
                    <textarea id="variables" placeholder='{"ansible_user": "deploy", "ansible_port": 22}'></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Store inventory data for editing
        const inventoryData = {{ inventory_json|safe }};

        function showAddModal() {
            document.getElementById('modalTitle').textContent = 'Add Host';
            document.getElementById('itemId').value = '';
            document.getElementById('hostname').value = '';
            document.getElementById('displayName').value = '';
            document.getElementById('group').value = '';
            document.getElementById('description').value = '';
            document.getElementById('variables').value = '';
            document.getElementById('itemModal').classList.add('active');
        }

        function showEditModal(itemId) {
            const item = inventoryData.find(i => i.id === itemId);
            if (!item) return;

            document.getElementById('modalTitle').textContent = 'Edit Host';
            document.getElementById('itemId').value = item.id;
            document.getElementById('hostname').value = item.hostname || '';
            document.getElementById('displayName').value = item.display_name || '';
            document.getElementById('group').value = item.group || '';
            document.getElementById('description').value = item.description || '';
            document.getElementById('variables').value = item.variables ? JSON.stringify(item.variables, null, 2) : '';
            document.getElementById('itemModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('itemModal').classList.remove('active');
        }

        async function saveItem(event) {
            event.preventDefault();

            const itemId = document.getElementById('itemId').value;
            const data = {
                hostname: document.getElementById('hostname').value,
                display_name: document.getElementById('displayName').value,
                group: document.getElementById('group').value || 'ungrouped',
                description: document.getElementById('description').value
            };

            // Parse variables JSON
            const varsText = document.getElementById('variables').value.trim();
            if (varsText) {
                try {
                    data.variables = JSON.parse(varsText);
                } catch (e) {
                    alert('Invalid JSON in variables field');
                    return;
                }
            } else {
                data.variables = {};
            }

            const url = itemId ? `/api/inventory/${itemId}` : '/api/inventory';
            const method = itemId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    location.reload();
                } else {
                    const err = await response.json();
                    alert('Error: ' + (err.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error saving item: ' + e.message);
            }
        }

        async function deleteItem(itemId, hostname) {
            if (!confirm(`Delete "${hostname}"?`)) return;

            try {
                const response = await fetch(`/api/inventory/${itemId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    location.reload();
                } else {
                    const err = await response.json();
                    alert('Error: ' + (err.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error deleting item: ' + e.message);
            }
        }

        function filterInventory() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const cards = document.querySelectorAll('.inventory-card');

            cards.forEach(card => {
                const hostname = card.dataset.hostname;
                const group = card.dataset.group;
                const description = card.dataset.description;

                if (hostname.includes(search) || group.includes(search) || description.includes(search)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>
