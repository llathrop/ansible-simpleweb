{% extends "base.html" %}
{% block title %}Users - Ansible Web Interface{% endblock %}

{% block head_extras %}
<style>
.section { background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
.section h2 { margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid var(--border-primary); padding-bottom: 10px; }
.users-table { width: 100%; border-collapse: collapse; }
.users-table th, .users-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-primary); }
.users-table th { background: var(--bg-tertiary); font-weight: 600; color: var(--text-secondary); }
.users-table tr:hover { background: var(--bg-tertiary); }
.role-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-right: 4px; margin-bottom: 2px; background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-primary); }
.role-badge.admin { background: rgba(239, 68, 68, 0.15); color: #ef4444; border-color: rgba(239, 68, 68, 0.3); }
.role-badge.operator { background: rgba(59, 130, 246, 0.15); color: #3b82f6; border-color: rgba(59, 130, 246, 0.3); }
.role-badge.monitor { background: rgba(34, 197, 94, 0.15); color: #22c55e; border-color: rgba(34, 197, 94, 0.3); }
.status-enabled { color: var(--status-completed-text, #22c55e); }
.status-disabled { color: var(--status-failed-text, #ef4444); }
.btn-group { display: flex; gap: 8px; }
.btn-sm { padding: 4px 10px; font-size: 0.85em; }
.btn-danger { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
.btn-danger:hover { background: rgba(239, 68, 68, 0.3); }
.msg { padding: 12px 16px; border-radius: 6px; margin-bottom: 16px; display: none; }
.msg.err { background: var(--status-failed-bg, rgba(239, 68, 68, 0.1)); color: var(--status-failed-text, #ef4444); }
.msg.ok { background: var(--status-completed-bg, rgba(34, 197, 94, 0.1)); color: var(--status-completed-text, #22c55e); }
.msg.visible { display: block; }
.header-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.empty-state { text-align: center; padding: 40px; color: var(--text-muted); }
</style>
{% endblock %}

{% block content %}
<div class="container container-wide">
    <h1>User Management</h1>
    <p class="subtitle">Manage user accounts, roles, and access permissions</p>

    <div id="msgBox" class="msg"></div>

    <div class="section">
        <div class="header-actions">
            <h2 style="margin: 0; border: none; padding: 0;">Users</h2>
            <a href="/users/new" class="btn btn-primary">Add User</a>
        </div>

        <div id="usersContainer">
            <p>Loading users...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block footer_scripts %}
<script>
function showMsg(text, isErr) {
    var el = document.getElementById('msgBox');
    el.textContent = text;
    el.className = 'msg ' + (isErr ? 'err' : 'ok') + ' visible';
    setTimeout(function() { el.classList.remove('visible'); }, 5000);
}

function loadUsers() {
    fetch('/api/users')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.error) {
                document.getElementById('usersContainer').innerHTML = '<p class="empty-state">Error: ' + data.error + '</p>';
                return;
            }

            var users = data.users || [];
            if (users.length === 0) {
                document.getElementById('usersContainer').innerHTML = '<p class="empty-state">No users found. Create one to get started.</p>';
                return;
            }

            var html = '<table class="users-table"><thead><tr>' +
                '<th>Username</th><th>Email</th><th>Roles</th><th>Status</th><th>Last Login</th><th>Actions</th>' +
                '</tr></thead><tbody>';

            users.forEach(function(user) {
                var roles = (user.roles || []).map(function(r) {
                    var cls = 'role-badge';
                    if (r === 'admin') cls += ' admin';
                    else if (r === 'operator') cls += ' operator';
                    else if (r === 'monitor') cls += ' monitor';
                    return '<span class="' + cls + '">' + r + '</span>';
                }).join('');

                var statusCls = user.enabled ? 'status-enabled' : 'status-disabled';
                var statusText = user.enabled ? 'Enabled' : 'Disabled';

                var lastLogin = user.last_login ? new Date(user.last_login).toLocaleString() : 'Never';

                html += '<tr>' +
                    '<td><strong>' + user.username + '</strong></td>' +
                    '<td>' + (user.email || '-') + '</td>' +
                    '<td>' + (roles || '<span class="role-badge">none</span>') + '</td>' +
                    '<td class="' + statusCls + '">' + statusText + '</td>' +
                    '<td>' + lastLogin + '</td>' +
                    '<td class="btn-group">' +
                        '<a href="/users/' + user.username + '/edit" class="btn btn-secondary btn-sm">Edit</a>' +
                        '<button class="btn btn-danger btn-sm" onclick="deleteUser(\'' + user.username + '\')">Delete</button>' +
                    '</td></tr>';
            });

            html += '</tbody></table>';
            document.getElementById('usersContainer').innerHTML = html;
        })
        .catch(function(e) {
            document.getElementById('usersContainer').innerHTML = '<p class="empty-state">Failed to load users: ' + e.message + '</p>';
        });
}

function deleteUser(username) {
    if (!confirm('Are you sure you want to delete user "' + username + '"?')) return;

    fetch('/api/users/' + encodeURIComponent(username), { method: 'DELETE' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.ok) {
                showMsg('User "' + username + '" deleted successfully', false);
                loadUsers();
            } else {
                showMsg(data.error || 'Failed to delete user', true);
            }
        })
        .catch(function(e) { showMsg('Error: ' + e.message, true); });
}

loadUsers();
</script>
{% endblock %}
