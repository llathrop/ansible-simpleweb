{% extends "base.html" %}
{% block title %}Scheduled Playbooks - Ansible Web Interface{% endblock %}

{% block content %}
<div class="container container-wide">
    <h1>Scheduled Playbooks</h1>
    <p class="subtitle">Manage automated playbook execution</p>

    <div class="action-bar">
        <a href="/schedules/new" class="btn btn-primary">+ New Schedule</a>
    </div>

    {% if schedules %}
    {% set active_schedules = schedules|selectattr('enabled')|list %}
    {% if active_schedules %}
    <h2>Active Schedules</h2>
    <table class="schedule-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Playbook</th>
                <th>Target</th>
                <th>Recurrence</th>
                <th>Next Run</th>
                <th>Last Run</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for schedule in active_schedules %}
            <tr data-schedule-id="{{ schedule.id }}">
                <td>
                    <strong>{{ schedule.name }}</strong>
                    {% if schedule.is_batch %}
                    <span class="recurrence-badge" style="margin-left: 5px; background: var(--status-running-bg); color: var(--status-running-text);">Batch</span>
                    {% endif %}
                    {% if schedule.description %}
                    <br><small class="text-muted">{{ schedule.description }}</small>
                    {% endif %}
                </td>
                <td>
                    {% if schedule.is_batch and schedule.playbooks %}
                    <span title="{{ schedule.playbooks|join(', ') }}">{{ schedule.playbooks|length }} playbooks</span>
                    {% else %}
                    {{ schedule.playbook }}
                    {% endif %}
                </td>
                <td>
                    {% if schedule.is_batch and schedule.targets %}
                    <span title="{{ schedule.targets|join(', ') }}">{{ schedule.targets|length }} targets</span>
                    {% else %}
                    {{ schedule.target }}
                    {% endif %}
                </td>
                <td><span class="recurrence-badge">{{ schedule.recurrence_display }}</span></td>
                <td>{{ schedule.next_run_display }}</td>
                <td>{{ schedule.last_run_display }}</td>
                <td>
                    <span class="status-badge status-{{ schedule.last_status or 'ready' }}" data-status>
                        {% if schedule.run_count > 0 %}
                        {{ schedule.success_display }} completed
                        {% else %}
                        No runs
                        {% endif %}
                    </span>
                    {% if schedule.last_status %}
                    <br><small class="text-muted">Last: {{ schedule.last_status }}</small>
                    {% endif %}
                </td>
                <td class="actions">
                    <a href="/schedules/{{ schedule.id }}/history" class="btn btn-secondary btn-small">History</a>
                    {% if schedule.is_running %}
                    <button class="btn btn-danger btn-small" onclick="stopSchedule('{{ schedule.id }}')">Stop</button>
                    {% endif %}
                    <button class="btn btn-secondary btn-small" onclick="pauseSchedule('{{ schedule.id }}')">Pause</button>
                    <a href="/schedules/{{ schedule.id }}/edit" class="btn btn-secondary btn-small">Edit</a>
                    <button class="btn btn-danger btn-small" onclick="deleteSchedule('{{ schedule.id }}', '{{ schedule.name }}')">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    {% set paused_schedules = schedules|rejectattr('enabled')|list %}
    {% if paused_schedules %}
    <h2>Paused Schedules</h2>
    <table class="schedule-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Playbook</th>
                <th>Target</th>
                <th>Recurrence</th>
                <th>Last Run</th>
                <th>Run Count</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for schedule in paused_schedules %}
            <tr data-schedule-id="{{ schedule.id }}" class="paused-row">
                <td>
                    <strong>{{ schedule.name }}</strong>
                    {% if schedule.is_batch %}
                    <span class="recurrence-badge" style="margin-left: 5px; background: var(--status-running-bg); color: var(--status-running-text);">Batch</span>
                    {% endif %}
                    {% if schedule.description %}
                    <br><small class="text-muted">{{ schedule.description }}</small>
                    {% endif %}
                </td>
                <td>
                    {% if schedule.is_batch and schedule.playbooks %}
                    <span title="{{ schedule.playbooks|join(', ') }}">{{ schedule.playbooks|length }} playbooks</span>
                    {% else %}
                    {{ schedule.playbook }}
                    {% endif %}
                </td>
                <td>
                    {% if schedule.is_batch and schedule.targets %}
                    <span title="{{ schedule.targets|join(', ') }}">{{ schedule.targets|length }} targets</span>
                    {% else %}
                    {{ schedule.target }}
                    {% endif %}
                </td>
                <td><span class="recurrence-badge">{{ schedule.recurrence_display }}</span></td>
                <td>{{ schedule.last_run_display }}</td>
                <td>
                    {% if schedule.run_count > 0 %}
                    <span class="status-badge status-{{ schedule.last_status or 'ready' }}">
                        {{ schedule.success_display }} completed
                    </span>
                    {% else %}
                    <span class="text-muted">No runs</span>
                    {% endif %}
                </td>
                <td class="actions">
                    <a href="/schedules/{{ schedule.id }}/history" class="btn btn-secondary btn-small">History</a>
                    <button class="btn btn-primary btn-small" onclick="resumeSchedule('{{ schedule.id }}')">Resume</button>
                    <a href="/schedules/{{ schedule.id }}/edit" class="btn btn-secondary btn-small">Edit</a>
                    <button class="btn btn-danger btn-small" onclick="deleteSchedule('{{ schedule.id }}', '{{ schedule.name }}')">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    {% else %}
    <div class="empty-state">
        <p>No schedules configured yet.</p>
        <p>Click "New Schedule" to create your first automated playbook run.</p>
    </div>
    {% endif %}
</div>

<script src="/static/js/schedules.js"></script>
<script>
(function() {
    const socket = window.__socket || io();

    socket.on('connect', function() {
        socket.emit('join_schedules');
    });

    socket.on('schedule_started', function(data) {
        updateScheduleRow(data.schedule_id, 'running');
    });

    socket.on('schedule_completed', function(data) {
        updateScheduleRow(data.schedule_id, data.status);
        setTimeout(function() { location.reload(); }, 2000);
    });

    socket.on('schedule_status', function(data) {
        updateScheduleRow(data.schedule_id, data.enabled ? 'scheduled' : 'paused');
    });

    socket.on('schedule_deleted', function(data) {
        const row = document.querySelector('[data-schedule-id="' + data.schedule_id + '"]');
        if (row) row.remove();
    });

    function updateScheduleRow(scheduleId, status) {
        const row = document.querySelector('[data-schedule-id="' + scheduleId + '"]');
        if (row) {
            const badge = row.querySelector('[data-status]');
            if (badge) {
                badge.textContent = status;
                badge.className = 'status-badge status-' + status;
            }
        }
    }
})();
</script>
{% endblock %}
