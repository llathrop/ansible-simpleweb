---
# Change User Password Playbook
#
# Changes the password for a specified user on target hosts.
# Used for rotating credentials after exposure or as routine security practice.
#
# Usage:
#   ansible-playbook playbooks/change-user-password.yml -l <target> \
#     -e "target_user=svc_ansible" \
#     -e "new_password=YOUR_NEW_SECURE_PASSWORD"
#
# Or generate a random password:
#   NEW_PASS=$(openssl rand -base64 16)
#   echo "New password: $NEW_PASS"
#   ansible-playbook playbooks/change-user-password.yml -l <target> \
#     -e "target_user=svc_ansible" \
#     -e "new_password=$NEW_PASS"

- name: Change User Password
  hosts: all
  become: yes
  gather_facts: no

  vars:
    target_user: "{{ target_user | default('') }}"
    new_password: "{{ new_password | default('') }}"

  tasks:
    - name: Validate required variables
      ansible.builtin.fail:
        msg: "Required variable '{{ item }}' is not set. Use -e '{{ item }}=value'"
      when: lookup('vars', item) == ''
      loop:
        - target_user
        - new_password

    - name: Check if user exists
      ansible.builtin.getent:
        database: passwd
        key: "{{ target_user }}"
      register: user_check
      failed_when: false

    - name: Fail if user does not exist
      ansible.builtin.fail:
        msg: "User '{{ target_user }}' does not exist on {{ inventory_hostname }}"
      when: user_check.failed | default(false) or target_user not in (user_check.ansible_facts.getent_passwd | default({}))

    - name: Change user password
      ansible.builtin.user:
        name: "{{ target_user }}"
        password: "{{ new_password | password_hash('sha512') }}"
        update_password: always
      no_log: true

    - name: Password changed successfully
      ansible.builtin.debug:
        msg: "Password for user '{{ target_user }}' has been changed on {{ inventory_hostname }}"
